<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bater Ponto</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: linear-gradient(90deg, rgba(94, 255, 175, 1) 0%, rgba(227, 255, 241, 1) 15%, rgba(255, 255, 255, 1) 30%, rgba(255, 255, 255, 1) 50%, rgba(255, 255, 255, 1) 70%, rgba(227, 255, 241, 1) 85%, rgba(94, 255, 175, 1) 100%);
      padding: 40px;
      color: black;
    }
    h1 { font-size: 4rem; margin-bottom: 20px; color: black; }
    select, button {
      font-size: 1.1rem;
      padding: 1.5rem 3rem;
      margin: 15px;
      border-radius: 15px;
      border: none;
    }
    select {
      color: #333;
    }
    button {
      background-color: #2980b9;
      color: white;
      cursor: pointer;
      transition: transform 0.2s;
    }
    button:hover {
      transform: scale(1.05);
    }
    #msg { font-size: 1.5rem; margin-top: 30px; font-weight: bold; color: black; }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #e74c3c;
      color: #fff;
      padding: 40px 60px;
      border-radius: 20px;
      font-size: 2.5rem;
      display: none;
      box-shadow: 0 0 30px rgba(0,0,0,0.3);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <h1>Rel√≥gio de Ponto</h1>

  <select id="nome">
    <option value="">-- Selecione seu nome --</option>
    <option value="ANT√îNIO">ANT√îNIO</option>
    <option value="EDUARDO">EDUARDO</option>
    <option value="GIOVANA">GIOVANA</option>
    <option value="HILTON">HILTON</option>
    <option value="HILDA">HILDA</option>
    <option value="PABLO">PABLO</option>
    <option value="PAULO">PAULO</option>
    <option value="PRISCILA">PRISCILA</option>
    <option value="VANESSA">VANESSA</option>

  </select><br>

  <select id="tipoPonto">
    <option value="">-- Tipo de ponto --</option>
    <option value="Entrada Manh√£">Entrada Manh√£</option>
    <option value="Sa√≠da Caf√© (Manh√£)">Sa√≠da Caf√© (Manh√£)</option>
    <option value="Volta Caf√© (Manh√£)">Volta Caf√© (Manh√£)</option>
    <option value="Sa√≠da Almo√ßo">Sa√≠da Almo√ßo</option>
    <option value="Volta Almo√ßo">Volta Almo√ßo</option>
    <option value="Sa√≠da Caf√© (Tarde)">Sa√≠da Caf√© (Tarde)</option>
    <option value="Volta Caf√© (Tarde)">Volta Caf√© (Tarde)</option>
    <option value="Sa√≠da Tarde">Sa√≠da Tarde</option>
  </select><br>

  <button onclick="confirmarPonto()">Bater Ponto</button>

  <div id="msg"></div>
  <div class="popup" id="popup">‚ùå Fora da √°rea permitida!</div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwcHewyj09jageeljbK9u88ngXe12RNh4XVzrzuMeiK6qF6N5zxeDlDbXQwzLWHNc-a/exec";
    const LOCAIS_PERMITIDOS = [
  { lat: -23.136030, lon: -47.168871 },
  { lat: -23.126797, lon: -47.164379 }
    ];
    const RAIO_METROS = 200000000; // +/- inutil por agora
    const TEMPO_MAX = 15;

    //ve se nao fez coisa errada
    let  UltimaV = Date.now();

    // ve se nao esta muito longe do ponto selecionado
    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    // fala se ta fazendo coisa errada
    function mostrarPopup(msg) {
      const popup = document.getElementById("popup");
      popup.textContent = msg;
      popup.style.display = "block";
      setTimeout(() => popup.style.display = "none", 4000);
    }

    function atualizarMsg(texto, cor="#000") {
      const msg = document.getElementById("msg");
      msg.style.color = cor;
      msg.textContent = texto;
    }
    // confirma√ß√£o pra nao bater no errado
    function confirmarPonto() {
      const TP = document.getElementById("tipoPonto").value;
      let txt = `Voc√™ vai bater o ponto ${TP}`;
      if(confirm(txt) == true)
        baterPonto();
      else
      alert("Selecione o Ponto correto.")
    }
    // ‚úÖ Gera token √öNICO por carregamento da p√°gina (n√£o por sess√£o!)
  const TOKEN = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    // bate o ponto
    function gerarToken() {
  return Array.from(crypto.getRandomValues(new Uint8Array(16)))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('')
    .substring(0, 16);
}
let jaEnviado = false;
    
function baterPonto() {
  if (jaEnviado) {
    alert("‚úÖ Ponto j√° enviado. Reescaneie o QR Code para bater outro.");
    return;
  }
  jaEnviado = true;
  const nome = document.getElementById("nome").value;
  const tipo = document.getElementById("tipoPonto").value;

  if (!nome) return alert("‚ö†Ô∏è Selecione seu nome.");
  if (!tipo) return alert("‚ö†Ô∏è Selecione o tipo de ponto.");

  // üîë Token = nome + timestamp (√∫ltimos 6 d√≠gitos) + segundos arredondados
  // Ex: PAULO_1712345678_45 ‚Üí s√≥ v√°lido por ~30s
  const now = Math.floor(Date.now() / 1000); // segundos
  const slot = Math.floor(now / 30); // bloco de 30s
  const token = `${nome}_${now % 1000000}_${slot}`;

  atualizarMsg("üìç Localizando‚Ä¶");

  const timeout = setTimeout(() => {
    atualizarMsg("");
    alert("‚è∞ Tempo esgotado para obter localiza√ß√£o.");
  }, 6000);

  navigator.geolocation.getCurrentPosition(
    function(pos) {
      clearTimeout(timeout);
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      const dentroDeRaio = LOCAIS_PERMITIDOS.some(local =>
        calcularDistancia(local.lat, local.lon, lat, lon) <= RAIO_METROS
      );

      if (!dentroDeRaio) {
        mostrarPopup("‚ùå Fora da √°rea permitida!");
        atualizarMsg("");
        return;
      }

      atualizarMsg("üì§ Enviando‚Ä¶");

      fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `nome=${encodeURIComponent(nome)}&lat=${lat}&lon=${lon}&tipo=${encodeURIComponent(tipo)}&token=${encodeURIComponent(TOKEN)}`
  })
      .then(res => res.text())
      .then(msg => {
        if (msg.startsWith("‚úÖ")) {
          atualizarMsg(msg, "green");
        } else {
          jaEnviado = false;
          mostrarPopup(msg.replace("‚ùå ", "") || "Erro");
          atualizarMsg("");
        }
      })
      .catch(() => {
        atualizarMsg("");
        alert("‚ö†Ô∏è Falha ao enviar.");
      });
    },
    function() {
      clearTimeout(timeout);
      atualizarMsg("");
      alert("üìç GPS indispon√≠vel. Permita localiza√ß√£o.");
    },
    { enableHighAccuracy: true, timeout: 5000, maximumAge: 30000 }
  );
}
  </script>
</body>
</html>
