<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bater Ponto</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: linear-gradient(90deg, rgba(94, 255, 175, 1) 0%, rgba(227, 255, 241, 1) 15%, rgba(255, 255, 255, 1) 30%, rgba(255, 255, 255, 1) 50%, rgba(255, 255, 255, 1) 70%, rgba(227, 255, 241, 1) 85%, rgba(94, 255, 175, 1) 100%);
      padding: 40px;
      color: black;
      margin: 0;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      color: #000;
    }
    @media (min-width: 768px) {
      h1 { font-size: 4rem; }
    }
    select, button {
      font-size: 1.8rem;
      padding: 1rem 2rem;
      margin: 10px;
      border-radius: 12px;
      border: none;
      width: 90%;
      max-width: 600px;
    }
    @media (min-width: 768px) {
      select, button {
        font-size: 3rem;
        padding: 1.5rem 3rem;
        margin: 15px;
      }
    }
    select {
      color: #333;
      background: white;
    }
    button {
      background-color: #2980b9;
      color: white;
      cursor: pointer;
      transition: transform 0.2s;
    }
    button:hover {
      transform: scale(1.03);
    }
    #msg {
      font-size: 1.8rem;
      margin-top: 20px;
      font-weight: bold;
      color: #000;
      min-height: 3rem;
    }
    @media (min-width: 768px) {
      #msg { font-size: 3rem; }
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #e74c3c;
      color: #fff;
      padding: 30px 50px;
      border-radius: 16px;
      font-size: 2rem;
      display: none;
      box-shadow: 0 0 25px rgba(0,0,0,0.4);
      z-index: 1000;
      text-align: center;
    }
    @media (min-width: 768px) {
      .popup { font-size: 2.5rem; padding: 40px 60px; }
    }
  </style>
</head>
<body>
  <h1>Rel√≥gio de Ponto</h1>

  <select id="nome">
    <option value="">-- Selecione seu nome --</option>
    <option value="ANT√îNIO">ANT√îNIO</option>
    <option value="EDUARDO">EDUARDO</option>
    <option value="GIOVANA">GIOVANA</option>
    <option value="HILTON">HILTON</option>
    <option value="HILDA">HILDA</option>
    <option value="PABLO">PABLO</option>
    <option value="PAULO">PAULO</option>
    <option value="PRISCILA">PRISCILA</option>
    <option value="VANESSA">VANESSA</option>
  </select>

  <select id="tipoPonto">
    <option value="">-- Tipo de ponto --</option>
    <option value="Entrada Manh√£">Entrada Manh√£</option>
    <option value="Sa√≠da Caf√© (Manh√£)">Sa√≠da Caf√© (Manh√£)</option>
    <option value="Volta Caf√© (Manh√£)">Volta Caf√© (Manh√£)</option>
    <option value="Sa√≠da Almo√ßo">Sa√≠da Almo√ßo</option>
    <option value="Volta Almo√ßo">Volta Almo√ßo</option>
    <option value="Sa√≠da Caf√© (Tarde)">Sa√≠da Caf√© (Tarde)</option>
    <option value="Volta Caf√© (Tarde)">Volta Caf√© (Tarde)</option>
    <option value="Sa√≠da Tarde">Sa√≠da Tarde</option>
  </select>

  <button onclick="baterPonto()">Bater Ponto</button>

  <div id="msg"></div>
  <div class="popup" id="popup">‚ùå Fora da √°rea permitida!</div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwcHewyj09jageeljbK9u88ngXe12RNh4XVzrzuMeiK6qF6N5zxeDlDbXQwzLWHNc-a/exec";
    const LAT_PERMITIDA = -23.136030;
    const LON_PERMITIDA = -47.168871;
    const RAIO_METROS = 20;

    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function mostrarPopup(msg) {
      const popup = document.getElementById("popup");
      popup.textContent = msg;
      popup.style.display = "block";
      setTimeout(() => popup.style.display = "none", 4000);
    }

    function atualizarMsg(texto, cor = "#000") {
      const msg = document.getElementById("msg");
      msg.style.color = cor;
      msg.textContent = texto;
    }

    function obterDistanciaEstavel() {
      return new Promise((resolve, reject) => {
        const leituras = [];
        let tentativas = 0;
        const MAX_TENTATIVAS = 5;

        function tentar() {
          if (tentativas >= MAX_TENTATIVAS) {
            if (leituras.length === 0) return reject("Sem leituras v√°lidas.");
            const distancias = leituras.map(l => l.distancia).sort((a, b) => a - b);
            const medianIndex = Math.floor(distancias.length / 2);
            const medianaDist = distancias[medianIndex];
            const dentro = leituras.filter(l => l.distancia <= RAIO_METROS).length;
            resolve({ medianaDist, dentro, total: leituras.length, exemplo: leituras[medianIndex] });
            return;
          }

          tentativas++;
          navigator.geolocation.getCurrentPosition(
            pos => {
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              const accuracy = pos.coords.accuracy || 999;
              const distancia = calcularDistancia(LAT_PERMITIDA, LON_PERMITIDA, lat, lon);
              if (accuracy <= 60) {
                leituras.push({ lat, lon, accuracy, distancia });
              }
              setTimeout(tentar, 250);
            },
            () => setTimeout(tentar, 300),
            { enableHighAccuracy: true, timeout: 4000, maximumAge: 0 }
          );
        }

        tentar();
      });
    }

    async function baterPonto() {
      const nome = document.getElementById("nome").value;
      const tipo = document.getElementById("tipoPonto").value;

      if (!nome) return alert("Selecione seu nome!");
      if (!tipo) return alert("Selecione o tipo de ponto!");

      atualizarMsg("üìç Obtendo localiza√ß√£o...");

      try {
        const { medianaDist, dentro, total, exemplo } = await obterDistanciaEstavel();

        if (dentro < 3 || medianaDist > RAIO_METROS) {
          mostrarPopup(`‚ùå Fora da √°rea!\nVoc√™ est√° a ${medianaDist.toFixed(1)} m do local.`);
          atualizarMsg("");
          return;
        }

        atualizarMsg("üïì Enviando ponto...", "#2980b9");

        fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `nome=${encodeURIComponent(nome)}&lat=${exemplo.lat}&lon=${exemplo.lon}&tipo=${encodeURIComponent(tipo)}`
        });

        setTimeout(() => {
          atualizarMsg(`‚úÖ ${tipo} registrada.`, "green");
        }, 600);

      } catch (err) {
        alert("‚ö†Ô∏è N√£o foi poss√≠vel obter localiza√ß√£o!");
        atualizarMsg("");
      }
    }
  </script>
</body>
</html>
